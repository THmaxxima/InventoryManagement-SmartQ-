<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <!--DXMETADATA start type="MetaCharset" --><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8"><!--DXMETADATA end-->
    <meta http-equiv="X-UA-Compatible" value="IE=9" />

    <!--DXMETADATA start type="IsTemplateFileFeatureEnabled" name="Responsive" format="<meta name=""viewport"" content=""width=device-width, initial-scale=1.0"" />" --><!--DXMETADATA end-->

    <!--DXMETADATA start type="Literal" condition="helpversion:value=3" value="<meta name=""Microsoft.Help.SelfBranded"" content=""true"" />" --><!--DXMETADATA end-->

    <!--DXMETADATA start type="ItemTitle" format="<title>%%LocalItemTitle%%</title>" --><title>dbo.proc_IVM_ChildStorageData_1726 Stored Procedure</title><!--DXMETADATA end-->
    <!--DXMETADATA start type="ItemTitle" format="<meta name=""Title"" content=""%%ItemTitleNoQuotes%%""/>" --><meta name="Title" content=""/><!--DXMETADATA end-->    
    

    <!--DXMETADATA start type="PackageLink" packagename="jquery" filetype="script" firstlinkattributes="id=""mshs_support_script"""--><script src="template/packages/jquery/script/chm.mshc/jquery-1.7.2.min.js" type="text/javascript" id="mshs_support_script"></script><!--DXMETADATA end-->
    <!--DXMETADATA start type="PackageLink" packagename="jquery-ui" filetype="script"--><script src="template/packages/jquery-ui/script/chm.mshc/jquery-ui-1.8.18.custom.min.js" type="text/javascript"></script><!--DXMETADATA end-->
    <!--DXMETADATA start type="PackageLink" packagename="jquery-ui" filetype="css"--><link rel="stylesheet" type="text/css" href="template/packages/jquery-ui/css/chm.mshc/jquery-ui-1.8.18.custom.css"></link><!--DXMETADATA end-->
	
    <!--DXMETADATA start type="PackageLink" packagename="plugins-db" filetype="css"--><link rel="stylesheet" type="text/css" href="template/packages/plugins-db/css/chm.mshc/jquery-plugins.css"></link><!--DXMETADATA end-->
    <!--DXMETADATA start type="PackageLink" packagename="core-db" filetype="css" firstlinkattributes=" data-mshv2-stylesheet=""/template/packages/core-db/dx.db.mshv2.css"" data-mshv1-stylesheet=""/template/packages/core-db/dx.db.mshv1.css"" data-responsive-mobile=""template/packages/core-db/dx.db.mobile.css"" data-responsive-tablet=""template/packages/core-db/dx.db.tablet.css"""--><link rel="stylesheet" type="text/css" href="template/packages/core-db/css/dx.db.css"  data-mshv2-stylesheet="/template/packages/core-db/dx.db.mshv2.css" data-mshv1-stylesheet="/template/packages/core-db/dx.db.mshv1.css" data-responsive-mobile="template/packages/core-db/dx.db.mobile.css" data-responsive-tablet="template/packages/core-db/dx.db.tablet.css"></link><!--DXMETADATA end-->
    <!--DXMETADATA start type="PackageLink" packagename="plugins-db" filetype="script"--><script src="template/packages/plugins-db/script/chm.mshc/jquery-plugins.min.js" type="text/javascript"></script><!--DXMETADATA end-->
    <!--DXMETADATA start type="PackageLink" packagename="core-db" filetype="script"--><script src="template/packages/core-db/script/dx.db.min.js" type="text/javascript"></script><!--DXMETADATA end-->
    
    <!--DXMETADATA start type="TopicId" format="<meta name=""Microsoft.Help.Id"" content=""%%TopicId%%""/>" --><meta name="Microsoft.Help.Id" content="IVM Database_db~s-dbo~p-proc_IVM_ChildStorageData_1726"/><!--DXMETADATA end-->
    <!--DXMETADATA start type="Synopsis" StripHtmlTags="True" MaxLength="250" format="<meta name=""Description"" content=""%%Synopsis%%"" />"--><meta name="Description" content="Sub area data." /><!--DXMETADATA end-->
    <!--DXMETADATA start type="TocParentId" format="<meta name=""Microsoft.Help.TocParent"" content=""%%TocParentId%%""/>" --><!--DXMETADATA end-->
    <meta name="Microsoft.Help.ContentType" content="Reference" />
    <!--DXMETADATA start type="MshvKeywords" condition="helpversion:value=3" --><!--DXMETADATA end-->
    <!--DXMETADATA start type="MshvMetaTags" condition="helpversion:value=3" --><!--DXMETADATA end-->
    <!--DXMETADATA start type="Help3CatalogLocale" condition="helpversion:value=3" format="<meta name=""Microsoft.Help.Locale"" content=""%%Help3CatalogLocale%%"" />"--><!--DXMETADATA end-->
    <!--DXMETADATA start type="Help3CatalogLocale" condition="helpversion:value=3" format="<meta name=""Microsoft.Help.TopicLocale"" content=""%%Help3CatalogLocale%%"" />"--><!--DXMETADATA end-->
    
    <!--DXMETADATA start type="Stylesheets" --><link rel="stylesheet" type="text/css" href="stylesheets/Title.css"></link>
    <link rel="stylesheet" type="text/css" href="stylesheets/customstyles.css"></link><!--DXMETADATA end-->
    <!--DXMETADATA start type="Scripts" --><!--DXMETADATA end-->

    <!--DXMETADATA start type="DesignTime"--><!--DXMETADATA end-->

    <!--DXMETADATA start type="Scrap" condition="communityenabled" name="_COMMUNITY_PROPERTIES" --><!--DXMETADATA end -->

    <!--DXMETADATA start type="CustomHeadContent" --><!--DXMETADATA end-->
</head>

<body>
    <div id="i-before-header-content" class="i-before-header-content">
        
    </div>
    <div id="i-header-content" class="i-header-content">
        <!--DXMETADATA start type="LogoImage" --><!--DXMETADATA end-->
            <div class="i-project-title"><!--DXMETADATA start type="ProjectTitle" -->Inventory Management (FC.IVM)<!--DXMETADATA end--></div>
        <div class="i-page-title"><div class="i-page-title-text"><!--DXMETADATA start type="LocalItemTitle" -->dbo.proc_IVM_ChildStorageData_1726 Stored Procedure<!--DXMETADATA end--></div></div>
    </div>
    <div id="i-after-header-content" class="i-after-header-content">
        <!-- Spacing --> <span class="i-toggle-all-sections i-function-link">
                <label class="i-collapse-all"><!--DXMETADATA start type="Phrase" name="COLLAPSE_ALL" -->Collapse All<!--DXMETADATA end--></label>
                <label class="i-expand-all" style="display: none;"><!--DXMETADATA start type="Phrase" name="EXPAND_ALL" -->Expand All<!--DXMETADATA end--></label>
            </span><!--DXMETADATA start type="Literal" condition="communityenabled" value="%%scrap:name=_COMMUNITY_DROPDOWN%%" --><!--DXMETADATA end -->
        <!--DXMETADATA start type="IsWebOutputRootPageLinkEnabled" format="<a href='#' class="i-page-link" class="i-view-in-frame-link" title='$$VIEW_WITH_NAVIGATION_TOOLS_TIP$$' style='display: none' data-root-page='%%WebOutputRootPage%%%%OutputFileExtension%%' target='_top'>$$VIEW_WITH_NAVIGATION_TOOLS_TEXT$$</a>" --><!--DXMETADATA end-->
    </div>
    <!--DXMETADATA start type="Breadcrumbs" scrap="_BREADCRUMBS" --><div class="i-breadcrumbs-container"><table><tr><td>
<a href="IVM Database_db.html">IVM Database Database</a>
 > <a href="IVM Database_db~s-dbo.html">dbo Schema</a>
 : dbo.proc_IVM_ChildStorageData_1726 Stored Procedure</td></tr></table></div><!--DXMETADATA end -->
    
    
    <div id="i-body-content" class="i-body-content">
        <!--DXMETADATA start type="Description" source="Item" format="%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=description,caption=$$Description$$%%<div class=""i-description-content"">%%description%%</div></div>" --><div class="i-section-heading" id="i-description-section-heading"><span class="i-section-heading-icon"><!-- --></span><span class="i-section-heading-text">Description</span></div><div id="i-description-section-content" class="i-section-content"><div class="i-description-content">Sub area data.</div></div><!--DXMETADATA end -->
            <!--DXMETADATA start type="FilteredItemList" scrap="PROPERTY_LIST" namespace="property" source="Item" filter="" format="%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=properties,caption=$$properties$$%%%%filtereditemlist%%</div>" --><div class="i-section-heading" id="i-properties-section-heading"><span class="i-section-heading-icon"><!-- --></span><span class="i-section-heading-text">Properties</span></div><div id="i-properties-section-content" class="i-section-content"><table class="i-property-list">
<tr><td>Creation Date</td><td>19/02/2018 13:42:50</td></tr>
<tr><td>Encrypted</td><td><img src="template/packages/core-db/images/boolean-false.gif"/></td></tr>
<tr><td>Ansi Nulls</td><td><img src="template/packages/core-db/images/boolean-true.gif"/></td></tr>
</table></div><!--DXMETADATA end -->
            <!--DXMETADATA start type="FilteredItemList" scrap="PARAMETER_LIST" namespace="parameter" source="Item" filter="" format="%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=parameters,caption=$$parameters$$%%%%filtereditemlist%%</div>" --><div class="i-section-heading" id="i-parameters-section-heading"><span class="i-section-heading-icon"><!-- --></span><span class="i-section-heading-text">Parameters</span></div><div id="i-parameters-section-content" class="i-section-content"><table class="i-column-list"><tr><th>Parameter</th><th NOWRAP>Direction</th><th NOWRAP>Description</th><th NOWRAP>Data Type</th><th NOWRAP>Size</th></tr>
<tr><td class="i-link">@GroupID</td><td>In</td><td class="i-description">รหัสของ Parent area</td><td>Integer</td><td>4</td></tr>
<tr><td class="i-link">@FieldStorageID</td><td>In</td><td class="i-description">รหัสของลาน</td><td>Integer</td><td>4</td></tr>
<tr><td class="i-link">@RETURN_VALUE</td><td>Return Value</td><td class="i-description">&nbsp;</td><td>Integer</td><td>4</td></tr>
</table></div><!--DXMETADATA end -->
            <!--DXMETADATA start type="TaggedComment" source="Item" id="##RETURNS" format="%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=returns,caption=$$Return_Type$$%%<p>%%comment%%</p></div>" --><div class="i-section-heading" id="i-returns-section-heading"><span class="i-section-heading-icon"><!-- --></span><span class="i-section-heading-text">Returns</span></div><div id="i-returns-section-content" class="i-section-content"><p>รายละเอียดของพื้นที่กองเก็บย่อย ในแต่ละลาน</p></div><!--DXMETADATA end -->
            <!--DXMETADATA start type="TaggedComment" source="Item" id="##REMARKS" format="%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=remarks,caption=$$Remarks$$%%<p>%%comment%%</p></div>" --><!--DXMETADATA end -->
            <!--DXMETADATA start type="FilteredItemList" scrap="PROCEDURE_PERMISSIONS" namespace="user" source="Item" filter="type=permissions" format="%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=userpermissions,caption=$$user$$ $$permissions$$%%%%filtereditemlist%%</div>" --><!--DXMETADATA end -->
            <!--DXMETADATA start type="FilteredItemList" scrap="PROCEDURE_PERMISSIONS" namespace="role" source="Item" filter="type=permissions" format="%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=rolepermissions,caption=$$role$$ $$permissions$$%%%%filtereditemlist%%</div>" --><!--DXMETADATA end -->
            <!--DXMETADATA start type="FilteredItemList" scrap="DEPENDENCY_LIST" namespace="child item" source="Item" filter="type=children" format="%%replaceinquotes:value=false%%%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=children,caption=""$$dependent_child$$""%%%%filtereditemlist%%</div>" --><!--DXMETADATA end -->
            <!--DXMETADATA start type="FilteredItemList" scrap="DEPENDENCY_LIST" namespace="child item" source="Item" filter="type=parent" format="%%replaceinquotes:value=false%%%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=parents,caption=""$$dependent_parent$$""%%%%filtereditemlist%%</div>" --><!--DXMETADATA end -->
            <!--DXMETADATA start type="Source" format="%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=source,caption=$$ProcedureSource$$%%<table class="i-sql-source" border=0 cellpadding=0><tr><td><CODE>%%Source%%</CODE></td></tr></table></div>" --><div class="i-section-heading" id="i-source-section-heading"><span class="i-section-heading-icon"><!-- --></span><span class="i-section-heading-text">Procedure Source Code</span></div><div id="i-source-section-content" class="i-section-content"><table class="i-sql-source" border=0 cellpadding=0><tr><td><CODE><pre><span style="color: #008080; ">-- =============================================
-- Author:        Yuthapong Wongtharua
-- Create date: 18 Jan 2018
-- Description:    Show child area of parent area provided
-- =============================================
/*
    19 Feb 2018: Edit to deduct buffer movement amount also
    5 Mar 2018: change concept to be GroupID
    23 Apr 2018: Aging added
    3 May 2018: Shared location (Group0) not show... Shared location must not limit to FieldStorage.. any must see it
            Moreover, big change.. this store must return all sub area not matter it has stock or not.
    7 May 2018: Netting problem on unload from Truck and move later. Example: truck1 =&gt; A01.0, A01.0 =&gt; A02.0.. A01.0 should be netting and can see remaining but it's not for now.
    25 Jun 2018: Age Calculation change to use StockDate as reference
*/</span>

<span style="color: #0000FF; ">CREATE</span> <span style="color: #0000FF; ">PROCEDURE</span> proc_IVM_ChildStorageData_1726
    <span style="color: #008000; ">@GroupID</span> <span style="color: #0000FF; ">Int</span>,
    <span style="color: #008000; ">@FieldStorageID</span> <span style="color: #0000FF; ">Int</span><span style="color: #808080; ">=-</span><span style="color: #800000; font-weight: bold; ">1</span>
<span style="color: #0000FF; ">AS</span>

<span style="color: #0000FF; ">BEGIN</span>
    <span style="color: #0000FF; ">declare</span> <span style="color: #008000; ">@UserMsg</span> <span style="color: #0000FF; ">varchar</span>(<span style="color: #800000; font-weight: bold; ">150</span>);
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@DTResult</span> <span style="color: #0000FF; ">table</span>(ID <span style="color: #0000FF; ">Int</span> <span style="color: #FF00FF; ">identity</span>,StorageID <span style="color: #0000FF; ">Int</span>,StorageName <span style="color: #0000FF; ">varchar</span>(<span style="color: #800000; font-weight: bold; ">50</span>),MaterialID <span style="color: #0000FF; ">Int</span>
    ,MaterialName <span style="color: #0000FF; ">varchar</span>(<span style="color: #800000; font-weight: bold; ">50</span>),WeightADT <span style="color: #0000FF; ">decimal</span>(<span style="color: #800000; font-weight: bold; ">18</span>,<span style="color: #800000; font-weight: bold; ">3</span>),Quantity <span style="color: #0000FF; ">int</span>,AgeDay <span style="color: #0000FF; ">int</span>)
Validate:
    <span style="color: #008080; ">--If exists(select m.id from MT_StorageArea m where m.id =@StorageID and m.ParentStorageID is not null)
</span>    <span style="color: #008080; ">--    Begin
</span>    <span style="color: #008080; ">--        Set @UserMsg='This is not parent storage. Please check your storage ID'
</span>    <span style="color: #008080; ">--        RaisError(@UserMsg,11,11)
</span>    <span style="color: #008080; ">--        Return
</span>    <span style="color: #008080; ">--    End
</span>
ProcessStart:
    <span style="color: #0000FF; ">If</span> <span style="color: #008000; ">@GroupID</span> <span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">999999</span>
        <span style="color: #0000FF; ">begin</span>
            <span style="color: #0000FF; ">Insert</span> <span style="color: #0000FF; ">into</span> <span style="color: #008000; ">@DTResult</span>(StorageID,StorageName,MaterialID,MaterialName,WeightADT,Quantity)
            <span style="color: #0000FF; ">Select</span> ms.ID,ms.Name <span style="color: #0000FF; ">as</span> StorageName,d.MaterialID,mm.Name <span style="color: #0000FF; ">as</span> MaterialName
            ,<span style="color: #FF00FF; ">sum</span>(d.CurrentWgt)<span style="color: #808080; ">/</span><span style="color: #800000; font-weight: bold; ">1000</span> <span style="color: #0000FF; ">as</span> WeightADT, <span style="color: #FF00FF; ">Sum</span>(d.CurrentQty) <span style="color: #0000FF; ">as</span> Quantity
            <span style="color: #0000FF; ">From</span> MT_StorageArea ms
            <span style="color: #808080; ">Left</span> <span style="color: #808080; ">Join</span> DT_StorageAreaMaterial d <span style="color: #0000FF; ">on</span> d.StorageID<span style="color: #808080; ">=</span>ms.id
            <span style="color: #808080; ">Left</span> <span style="color: #808080; ">Join</span> MT_Material mm <span style="color: #0000FF; ">on</span> mm.id <span style="color: #808080; ">=</span> d.MaterialID
            <span style="color: #0000FF; ">where</span> ms.GroupID <span style="color: #0000FF; ">Is</span> <span style="color: #0000FF; ">null</span>
            <span style="color: #808080; ">and</span> ms.ParentStorageID <span style="color: #808080; ">=</span><span style="color: #008000; ">@FieldStorageID</span> 
            <span style="color: #0000FF; ">Group</span> <span style="color: #0000FF; ">by</span> ms.ID,ms.Name,d.MaterialID,mm.Name

        <span style="color: #0000FF; ">end</span>
    <span style="color: #0000FF; ">else</span>
        <span style="color: #0000FF; ">If</span> <span style="color: #008000; ">@GroupID</span> <span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">0</span>
            <span style="color: #0000FF; ">begin</span>
                <span style="color: #0000FF; ">Insert</span> <span style="color: #0000FF; ">into</span> <span style="color: #008000; ">@DTResult</span>(StorageID,StorageName,MaterialID,MaterialName,WeightADT,Quantity)
                <span style="color: #0000FF; ">Select</span> ms.ID,ms.Name <span style="color: #0000FF; ">as</span> StorageName,d.MaterialID,mm.Name <span style="color: #0000FF; ">as</span> MaterialName
                ,<span style="color: #FF00FF; ">sum</span>(d.CurrentWgt)<span style="color: #808080; ">/</span><span style="color: #800000; font-weight: bold; ">1000</span> <span style="color: #0000FF; ">as</span> WeightADT, <span style="color: #FF00FF; ">Sum</span>(d.CurrentQty) <span style="color: #0000FF; ">as</span> Quantity
                <span style="color: #0000FF; ">From</span> MT_StorageArea ms
                <span style="color: #808080; ">Left</span> <span style="color: #808080; ">Join</span> DT_StorageAreaMaterial d <span style="color: #0000FF; ">on</span> d.StorageID<span style="color: #808080; ">=</span>ms.id
                <span style="color: #808080; ">Left</span> <span style="color: #808080; ">Join</span> MT_Material mm <span style="color: #0000FF; ">on</span> mm.id <span style="color: #808080; ">=</span> d.MaterialID
                <span style="color: #0000FF; ">where</span> ms.GroupID<span style="color: #808080; ">=</span><span style="color: #008000; ">@GroupID</span> 
                <span style="color: #0000FF; ">Group</span> <span style="color: #0000FF; ">by</span> ms.ID,ms.Name,d.MaterialID,mm.Name
            <span style="color: #0000FF; ">end</span>
        <span style="color: #0000FF; ">else</span>
            <span style="color: #0000FF; ">begin</span>
                <span style="color: #0000FF; ">Insert</span> <span style="color: #0000FF; ">into</span> <span style="color: #008000; ">@DTResult</span>(StorageID,StorageName,MaterialID,MaterialName,WeightADT,Quantity)
                <span style="color: #0000FF; ">Select</span> ms.ID,ms.Name <span style="color: #0000FF; ">as</span> StorageName,d.MaterialID,mm.Name <span style="color: #0000FF; ">as</span> MaterialName
                ,<span style="color: #FF00FF; ">sum</span>(d.CurrentWgt)<span style="color: #808080; ">/</span><span style="color: #800000; font-weight: bold; ">1000</span> <span style="color: #0000FF; ">as</span> WeightADT, <span style="color: #FF00FF; ">Sum</span>(d.CurrentQty) <span style="color: #0000FF; ">as</span> Quantity
                <span style="color: #0000FF; ">From</span> MT_StorageArea ms
                <span style="color: #808080; ">Left</span> <span style="color: #808080; ">Join</span> DT_StorageAreaMaterial d <span style="color: #0000FF; ">on</span> d.StorageID<span style="color: #808080; ">=</span>ms.id
                <span style="color: #808080; ">Left</span> <span style="color: #808080; ">Join</span> MT_Material mm <span style="color: #0000FF; ">on</span> mm.id <span style="color: #808080; ">=</span> d.MaterialID
                <span style="color: #0000FF; ">where</span> ms.GroupID<span style="color: #808080; ">=</span><span style="color: #008000; ">@GroupID</span> 
                <span style="color: #808080; ">and</span> ms.ParentStorageID <span style="color: #808080; ">=</span><span style="color: #008000; ">@FieldStorageID</span> 
                <span style="color: #0000FF; ">Group</span> <span style="color: #0000FF; ">by</span> ms.ID,ms.Name,d.MaterialID,mm.Name
            <span style="color: #0000FF; ">end</span>

UpdateFromBuffer:

<span style="color: #0000FF; ">Begin</span> <span style="color: #008080; ">-- Insert only new added material to new storage from DT_StorageAreaMaterialBuffer
</span>    
        <span style="color: #008080; ">-- deduct from source.. some storage is not in destination in buffer,so it won't exist in DTNet table. So it must be deducted here.
</span>        <span style="color: #008080; ">-- This must be done first, other wise double deduct will happen
</span>    <span style="color: #0000FF; ">Update</span> d
    <span style="color: #0000FF; ">Set</span> d.Quantity<span style="color: #808080; ">=</span>d.Quantity<span style="color: #808080; ">-</span><span style="color: #FF00FF; ">Isnull</span>(d1.Amount,<span style="color: #800000; font-weight: bold; ">0</span>),d.<span style="color: #FF0000; ">[WeightADT]</span> <span style="color: #808080; ">=</span>d.<span style="color: #FF0000; ">[WeightADT]</span><span style="color: #808080; ">-</span><span style="color: #FF00FF; ">ISNULL</span>(d1.<span style="color: #FF0000; ">[Weight]</span>,<span style="color: #800000; font-weight: bold; ">0</span>)
    <span style="color: #0000FF; ">From</span> <span style="color: #008000; ">@DTResult</span> d
    <span style="color: #808080; ">Left</span> <span style="color: #808080; ">Join</span> 
        (<span style="color: #0000FF; ">Select</span> d.SourceStorageID,d.MaterialID,<span style="color: #FF00FF; ">SUM</span>(d.Amount) <span style="color: #0000FF; ">as</span> Amount,<span style="color: #FF00FF; ">SUM</span>(d.<span style="color: #FF0000; ">[Weight]</span>)<span style="color: #808080; ">/</span><span style="color: #800000; font-weight: bold; ">1000</span> <span style="color: #0000FF; ">as</span> <span style="color: #FF0000; ">[Weight]</span>
        <span style="color: #0000FF; ">From</span> DT_StorageAreaMaterialBuffer d
        <span style="color: #0000FF; ">where</span> d.StatusID <span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">1</span>
        <span style="color: #0000FF; ">Group</span> <span style="color: #0000FF; ">by</span> d.SourceStorageID,d.MaterialID)d1 <span style="color: #0000FF; ">on</span> d1.SourceStorageID<span style="color: #808080; ">=</span>d.StorageID <span style="color: #808080; ">and</span> d1.MaterialID<span style="color: #808080; ">=</span>d.MaterialID


    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@DTNetBufferInventory</span> <span style="color: #0000FF; ">Table</span>(ID <span style="color: #0000FF; ">Int</span> <span style="color: #FF00FF; ">identity</span>,MaterialID <span style="color: #0000FF; ">Int</span>,StorageID <span style="color: #0000FF; ">Int</span>,Quantity <span style="color: #0000FF; ">float</span>,<span style="color: #FF0000; ">[Weight]</span> <span style="color: #0000FF; ">float</span>)
    <span style="color: #0000FF; ">Insert</span> <span style="color: #0000FF; ">into</span> <span style="color: #008000; ">@DTNetBufferInventory</span> (MaterialID,StorageID,Quantity,<span style="color: #FF0000; ">[Weight]</span>)
    <span style="color: #0000FF; ">Select</span> d.MaterialID ,d.DestinationStorageID,<span style="color: #FF00FF; ">SUM</span>(d.Amount) Qty,<span style="color: #FF00FF; ">SUM</span>(d.<span style="color: #FF0000; ">[Weight]</span>) <span style="color: #0000FF; ">as</span> <span style="color: #FF0000; ">[Weight]</span>
    <span style="color: #0000FF; ">From</span> DT_StorageAreaMaterialBuffer d
    <span style="color: #0000FF; ">where</span> d.StatusID <span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">1</span>
    <span style="color: #0000FF; ">Group</span> <span style="color: #0000FF; ">by</span> d.MaterialID ,d.DestinationStorageID ;


    <span style="color: #0000FF; ">Update</span> d
    <span style="color: #0000FF; ">set</span> d.Quantity <span style="color: #808080; ">=</span> d.Quantity <span style="color: #808080; ">-</span> d1.Quantity ,d.<span style="color: #FF0000; ">[Weight]</span><span style="color: #808080; ">=</span>d.<span style="color: #FF0000; ">[Weight]</span><span style="color: #808080; ">-</span>d1.<span style="color: #FF0000; ">[Weight]</span>
    <span style="color: #0000FF; ">From</span> <span style="color: #008000; ">@DTNetBufferInventory</span> d
    <span style="color: #808080; ">Join</span> 
        (<span style="color: #0000FF; ">Select</span> d.SourceStorageID,d.MaterialID,<span style="color: #FF00FF; ">SUM</span>(d.Amount) <span style="color: #0000FF; ">as</span> Quantity,<span style="color: #FF00FF; ">SUM</span>(d.<span style="color: #FF0000; ">[Weight]</span>) <span style="color: #0000FF; ">as</span> <span style="color: #FF0000; ">[Weight]</span>
        <span style="color: #0000FF; ">From</span> DT_StorageAreaMaterialBuffer d
        <span style="color: #0000FF; ">group</span> <span style="color: #0000FF; ">by</span> d.SourceStorageID,d.MaterialID) d1 <span style="color: #0000FF; ">on</span> d1.SourceStorageID <span style="color: #808080; ">=</span> d.StorageID <span style="color: #808080; ">and</span> d1.MaterialID <span style="color: #808080; ">=</span> d.MaterialID ;



    <span style="color: #0000FF; ">Delete</span> <span style="color: #0000FF; ">from</span> <span style="color: #008000; ">@DTNetBufferInventory</span> <span style="color: #0000FF; ">where</span> Quantity <span style="color: #808080; ">&lt;=</span><span style="color: #800000; font-weight: bold; ">0</span> <span style="color: #808080; ">or</span> <span style="color: #FF0000; ">[Weight]</span> <span style="color: #808080; ">&lt;=</span> <span style="color: #800000; font-weight: bold; ">0</span>;
    
    <span style="color: #008080; ">--select * from @DTNetBufferInventory 
</span>    <span style="color: #008080; ">--return
</span>
    <span style="color: #0000FF; ">if</span> <span style="color: #008000; ">@GroupID</span> <span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">999999</span>
        <span style="color: #0000FF; ">begin</span> 
            <span style="color: #0000FF; ">Insert</span> <span style="color: #0000FF; ">into</span> <span style="color: #008000; ">@DTResult</span>(StorageID,StorageName,MaterialID,MaterialName,WeightADT,Quantity)
            <span style="color: #0000FF; ">Select</span> d.StorageID,ms1.Name <span style="color: #0000FF; ">as</span> StorageName,d.MaterialID,mm.Name MaterialName,d.<span style="color: #FF0000; ">[Weight]</span><span style="color: #808080; ">/</span><span style="color: #800000; font-weight: bold; ">1000</span>,d.Quantity 
            <span style="color: #0000FF; ">From</span> <span style="color: #008000; ">@DTNetBufferInventory</span> d
            <span style="color: #808080; ">Join</span> MT_StorageArea ms1 <span style="color: #0000FF; ">on</span> ms1.ID <span style="color: #808080; ">=</span> d.StorageID 
            <span style="color: #808080; ">Join</span> MT_Material mm <span style="color: #0000FF; ">on</span> mm.ID <span style="color: #808080; ">=</span>d.MaterialID 
            <span style="color: #808080; ">Left</span> <span style="color: #808080; ">Join</span> <span style="color: #008000; ">@DTResult</span> DR <span style="color: #0000FF; ">on</span> DR.StorageID <span style="color: #808080; ">=</span> d.StorageID <span style="color: #808080; ">and</span> DR.MaterialID <span style="color: #808080; ">=</span> d.MaterialID 
            <span style="color: #0000FF; ">where</span> DR.StorageID <span style="color: #0000FF; ">is</span> <span style="color: #0000FF; ">null</span>
            <span style="color: #808080; ">and</span> ms1.GroupID <span style="color: #0000FF; ">is</span> <span style="color: #0000FF; ">null</span> ;
            
        <span style="color: #0000FF; ">end</span>
    <span style="color: #0000FF; ">else</span>
        <span style="color: #0000FF; ">begin</span>

            <span style="color: #0000FF; ">Insert</span> <span style="color: #0000FF; ">into</span> <span style="color: #008000; ">@DTResult</span>(StorageID,StorageName,MaterialID,MaterialName,WeightADT,Quantity)
            <span style="color: #0000FF; ">Select</span> d.StorageID,ms1.Name <span style="color: #0000FF; ">as</span> StorageName,d.MaterialID,mm.Name MaterialName,d.<span style="color: #FF0000; ">[Weight]</span><span style="color: #808080; ">/</span><span style="color: #800000; font-weight: bold; ">1000</span>,d.Quantity  
            <span style="color: #0000FF; ">From</span> <span style="color: #008000; ">@DTNetBufferInventory</span> d
            <span style="color: #808080; ">Join</span> MT_StorageArea ms1 <span style="color: #0000FF; ">on</span> ms1.ID <span style="color: #808080; ">=</span> d.StorageID 
            <span style="color: #808080; ">Join</span> MT_Material mm <span style="color: #0000FF; ">on</span> mm.ID <span style="color: #808080; ">=</span>d.MaterialID 
            <span style="color: #808080; ">Left</span> <span style="color: #808080; ">Join</span> <span style="color: #008000; ">@DTResult</span> DR <span style="color: #0000FF; ">on</span> DR.StorageID <span style="color: #808080; ">=</span> d.StorageID <span style="color: #808080; ">and</span> DR.MaterialID <span style="color: #808080; ">=</span> d.MaterialID 
            <span style="color: #0000FF; ">where</span> DR.StorageID <span style="color: #0000FF; ">is</span> <span style="color: #0000FF; ">null</span>
            <span style="color: #808080; ">and</span> ms1.GroupID <span style="color: #808080; ">=</span> <span style="color: #008000; ">@GroupID</span> ;
        
        <span style="color: #0000FF; ">end</span>
<span style="color: #0000FF; ">End</span>    




    


    <span style="color: #008080; ">-- add more to destination
</span>    <span style="color: #008080; ">--Update d
</span>    <span style="color: #008080; ">--Set d.Quantity=d.Quantity+Isnull(d1.Amount,0),d.[WeightADT] =d.[WeightADT]+ISNULL(d1.[Weight],0)
</span>    <span style="color: #008080; ">--From @DTResult d
</span>    <span style="color: #008080; ">--Left Join 
</span>    <span style="color: #008080; ">--    (Select d.DestinationStorageID,d.MaterialID,SUM(d.Amount) as Amount,SUM(d.[Weight])/1000 as [Weight]
</span>    <span style="color: #008080; ">--    From DT_StorageAreaMaterialBuffer d
</span>    <span style="color: #008080; ">--    where d.StatusID =1
</span>    <span style="color: #008080; ">--    Group by d.DestinationStorageID,d.MaterialID)d1 on d1.DestinationStorageID=d.StorageID and d1.MaterialID=d.MaterialID
</span>    <span style="color: #008080; ">--select * from @DTResult;
</span>    <span style="color: #008080; ">--return
</span>    <span style="color: #008080; ">-- add more from DT_InboundStoragebuffer
</span>    <span style="color: #008080; ">/* Remark here because amount in DT_InboundStorageBuffer was assigned into DT_StorageAreaBuffer since transaction happened. It will be double action*/</span>
    <span style="color: #008080; ">--Update d
</span>    <span style="color: #008080; ">--Set d.Quantity=d.Quantity+Isnull(DI.Amount,0),d.[WeightADT]=d.[WeightADT]+ISNULL(DI.[Weight],0)
</span>    <span style="color: #008080; ">--From @DTResult d
</span>    <span style="color: #008080; ">--Join
</span>    <span style="color: #008080; ">--    (Select DI.MaterialID,d1.DestinationStorageID,Sum(d1.Amount) as Amount,SUM(d1.[EstWeight]) as [Weight]
</span>    <span style="color: #008080; ">--    From DT_Inbound DI
</span>    <span style="color: #008080; ">--    Join View_DTInbound_LatestVersionID V on V.ID = DI.ID
</span>    <span style="color: #008080; ">--    Join DT_InboundStorageBuffer d1 on d1.Ticket = DI.DocID
</span>    <span style="color: #008080; ">--    where d1.StatusID =1
</span>    <span style="color: #008080; ">--    Group by DI.MaterialID ,d1.DestinationStorageID ) DI on DI.MaterialID = d.MaterialID and DI.DestinationStorageID=d.StorageID 
</span>

    
AgingCalculation:
    <span style="color: #008080; ">-- Update Age day from actual storage
</span>    <span style="color: #0000FF; ">Update</span> d
    <span style="color: #0000FF; ">Set</span> d.AgeDay <span style="color: #808080; ">=</span> <span style="color: #FF00FF; ">DATEDIFF</span>(<span style="color: #FF00FF; ">day</span>,DTStock.MinDate,<span style="color: #FF00FF; ">GETDATE</span>())
    <span style="color: #0000FF; ">From</span> <span style="color: #008000; ">@DTResult</span> d
    <span style="color: #808080; ">Join</span> 
        (<span style="color: #0000FF; ">Select</span> <span style="color: #FF00FF; ">MIN</span>(<span style="color: #FF00FF; ">Isnull</span>(d.StockDate,d.InsertDate)) MinDate,d.StorageID,d.MaterialID 
        <span style="color: #0000FF; ">From</span> DT_StorageAreaMaterial d
        <span style="color: #0000FF; ">Group</span> <span style="color: #0000FF; ">by</span> d.StorageID,d.MaterialID) DTStock <span style="color: #0000FF; ">on</span> DTStock.StorageID<span style="color: #808080; ">=</span>d.StorageID <span style="color: #808080; ">and</span> DTStock.MaterialID<span style="color: #808080; ">=</span>d.MaterialID ;

    <span style="color: #008080; ">-- Update new data from buffer
</span>    <span style="color: #0000FF; ">Update</span> d
    <span style="color: #0000FF; ">set</span> d.AgeDay <span style="color: #808080; ">=</span> <span style="color: #FF00FF; ">DATEDIFF</span>(<span style="color: #FF00FF; ">day</span>,DTStock.MinDate,<span style="color: #FF00FF; ">GETDATE</span>())
    <span style="color: #0000FF; ">From</span> <span style="color: #008000; ">@DTResult</span> d
    <span style="color: #808080; ">Join</span> (<span style="color: #0000FF; ">Select</span> d.DestinationStorageID,d.MaterialID ,<span style="color: #FF00FF; ">Min</span>(<span style="color: #FF00FF; ">Isnull</span>(d.StockDate,d.InsertDate)) <span style="color: #0000FF; ">as</span> MinDate
          <span style="color: #0000FF; ">From</span> DT_StorageAreaMaterialBuffer d
          <span style="color: #0000FF; ">Group</span> <span style="color: #0000FF; ">by</span> d.DestinationStorageID,d.MaterialID) DTStock <span style="color: #0000FF; ">on</span> DTStock.MaterialID<span style="color: #808080; ">=</span>d.MaterialID  <span style="color: #808080; ">and</span> DTStock.DestinationStorageID <span style="color: #808080; ">=</span> d.StorageID
    <span style="color: #0000FF; ">where</span> d.AgeDay <span style="color: #0000FF; ">is</span> <span style="color: #0000FF; ">null</span>;

DeleteNullArea:
    <span style="color: #008080; ">-- delete area has null material but still other record on same storage with exis material
</span>
    <span style="color: #0000FF; ">delete</span> <span style="color: #0000FF; ">from</span> <span style="color: #008000; ">@DTResult</span> 
    <span style="color: #0000FF; ">where</span> StorageID <span style="color: #808080; ">in</span>(
    <span style="color: #0000FF; ">select</span> a.StorageID 
    <span style="color: #0000FF; ">from</span> 
    (
    <span style="color: #0000FF; ">Select</span> d.StorageID 
    <span style="color: #0000FF; ">from</span> <span style="color: #008000; ">@DTResult</span> d
    <span style="color: #0000FF; ">where</span> d.MaterialID <span style="color: #0000FF; ">is</span> <span style="color: #0000FF; ">null</span>
    <span style="color: #0000FF; ">group</span> <span style="color: #0000FF; ">by</span> d.StorageID ) a
    <span style="color: #808080; ">Join</span>
    (
    <span style="color: #0000FF; ">Select</span> d.StorageID 
    <span style="color: #0000FF; ">from</span> <span style="color: #008000; ">@DTResult</span> d
    <span style="color: #0000FF; ">where</span> d.MaterialID <span style="color: #0000FF; ">is</span> <span style="color: #808080; ">not</span> <span style="color: #0000FF; ">null</span>
    <span style="color: #0000FF; ">group</span> <span style="color: #0000FF; ">by</span> d.StorageID ) b <span style="color: #0000FF; ">on</span> b.StorageID <span style="color: #808080; ">=</span> a.StorageID )
    <span style="color: #808080; ">and</span> MaterialID <span style="color: #0000FF; ">is</span> <span style="color: #0000FF; ">null</span>;

FinalStep:
    <span style="color: #0000FF; ">Select</span> <span style="color: #808080; ">*</span> <span style="color: #0000FF; ">from</span> <span style="color: #008000; ">@DTResult</span> d
    <span style="color: #0000FF; ">Order</span> <span style="color: #0000FF; ">by</span> d.StorageName,d.MaterialName ;
    <span style="color: #0000FF; ">return</span>

    <span style="color: #008080; ">--select * from DT_StorageAreaMaterialBuffer;
</span>
<span style="color: #0000FF; ">END</span>
</pre></CODE></td></tr></table></div><!--DXMETADATA end -->
            <a name="seealsobookmark"></a>
            <!--DXMETADATA start type="FilteredItemList" scrap="CATEGORIZED_LINKS" namespace="linkcategory" source="Item" filter="" NoHeader="True" NoFooter="True" format="%%replaceinquotes:value=false%%%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=seealso,caption=""$$See_Also$$%%designlist:tagidentifier=##SEEALSO,itemtype=See Also%%""%%%%filtereditemlist%%</div>"--><div class="i-section-heading" id="i-seealso-section-heading"><span class="i-section-heading-icon"><!-- --></span><span class="i-section-heading-text">See Also</span></div><div id="i-seealso-section-content" class="i-section-content"><h4 class=dxh4>Related Objects</h4><p><a href="IVM Database_db~s-dbo.html">dbo Schema</a>
<BR/><a href="IVM Database_db.html">IVM Database Database</a>
</p>
</div><!--DXMETADATA end-->
        
    </div>
    <div id="i-footer-content" class="i-footer-content">
        <!--DXMETADATA start type="Scrap" condition="communityenabled" name="_COMMUNITY_FOOTER" --><!--DXMETADATA end -->
<!--DXMETADATA start type="Variable" name="CopyrightNotice" format="<p>&nbsp;</p><p>&nbsp;</p><hr style=""height: 1px"" /><p>%%variable%%</p>" --><p>&nbsp;</p><p>&nbsp;</p><hr style="height: 1px" /><p>&copy; 2018 All Rights Reserved.</p><!--DXMETADATA end -->
<!--DXMETADATA start type="Variable" name="FeedbackLink" format="" --><a href="mailto:support@company.com?subject=Documentation Feedback: IVM Database_db~s-dbo~p-proc_IVM_ChildStorageData_1726.html">Send comments</a> on this topic.<!--DXMETADATA end-->
    </div>
    

    <!--DXMETADATA start type="IsNew" format="<script type=""text/javascript"">setIsNew = true;</script>" --><!--DXMETADATA end-->
    <!--DXMETADATA start type="IsTemplateFileFeatureEnabled" name="Responsive" format="<script type=""text/javascript"">setIsResponsiveEnabled = true;</script>" --><!--DXMETADATA end-->
    <script type="text/javascript">
        $(function() {
            var documentInstance = new Innovasys.Content.Document(document.body);
            documentInstance.isNew = !(typeof setIsNew === "undefined");
            documentInstance.isResponsiveEnabled = !(typeof setIsResponsiveEnabled === "undefined");
            documentInstance.load();
        });
    </script>
</body>
</html>
