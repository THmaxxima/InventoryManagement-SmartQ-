<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <!--DXMETADATA start type="MetaCharset" --><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8"><!--DXMETADATA end-->
    <meta http-equiv="X-UA-Compatible" value="IE=9" />

    <!--DXMETADATA start type="IsTemplateFileFeatureEnabled" name="Responsive" format="<meta name=""viewport"" content=""width=device-width, initial-scale=1.0"" />" --><!--DXMETADATA end-->

    <!--DXMETADATA start type="Literal" condition="helpversion:value=3" value="<meta name=""Microsoft.Help.SelfBranded"" content=""true"" />" --><!--DXMETADATA end-->

    <!--DXMETADATA start type="ItemTitle" format="<title>%%LocalItemTitle%%</title>" --><title>dbo.proc_IVM_UnloadTruckToTemp_1859 Stored Procedure</title><!--DXMETADATA end-->
    <!--DXMETADATA start type="ItemTitle" format="<meta name=""Title"" content=""%%ItemTitleNoQuotes%%""/>" --><meta name="Title" content=""/><!--DXMETADATA end-->    
    

    <!--DXMETADATA start type="PackageLink" packagename="jquery" filetype="script" firstlinkattributes="id=""mshs_support_script"""--><script src="template/packages/jquery/script/chm.mshc/jquery-1.7.2.min.js" type="text/javascript" id="mshs_support_script"></script><!--DXMETADATA end-->
    <!--DXMETADATA start type="PackageLink" packagename="jquery-ui" filetype="script"--><script src="template/packages/jquery-ui/script/chm.mshc/jquery-ui-1.8.18.custom.min.js" type="text/javascript"></script><!--DXMETADATA end-->
    <!--DXMETADATA start type="PackageLink" packagename="jquery-ui" filetype="css"--><link rel="stylesheet" type="text/css" href="template/packages/jquery-ui/css/chm.mshc/jquery-ui-1.8.18.custom.css"></link><!--DXMETADATA end-->
	
    <!--DXMETADATA start type="PackageLink" packagename="plugins-db" filetype="css"--><link rel="stylesheet" type="text/css" href="template/packages/plugins-db/css/chm.mshc/jquery-plugins.css"></link><!--DXMETADATA end-->
    <!--DXMETADATA start type="PackageLink" packagename="core-db" filetype="css" firstlinkattributes=" data-mshv2-stylesheet=""/template/packages/core-db/dx.db.mshv2.css"" data-mshv1-stylesheet=""/template/packages/core-db/dx.db.mshv1.css"" data-responsive-mobile=""template/packages/core-db/dx.db.mobile.css"" data-responsive-tablet=""template/packages/core-db/dx.db.tablet.css"""--><link rel="stylesheet" type="text/css" href="template/packages/core-db/css/dx.db.css"  data-mshv2-stylesheet="/template/packages/core-db/dx.db.mshv2.css" data-mshv1-stylesheet="/template/packages/core-db/dx.db.mshv1.css" data-responsive-mobile="template/packages/core-db/dx.db.mobile.css" data-responsive-tablet="template/packages/core-db/dx.db.tablet.css"></link><!--DXMETADATA end-->
    <!--DXMETADATA start type="PackageLink" packagename="plugins-db" filetype="script"--><script src="template/packages/plugins-db/script/chm.mshc/jquery-plugins.min.js" type="text/javascript"></script><!--DXMETADATA end-->
    <!--DXMETADATA start type="PackageLink" packagename="core-db" filetype="script"--><script src="template/packages/core-db/script/dx.db.min.js" type="text/javascript"></script><!--DXMETADATA end-->
    
    <!--DXMETADATA start type="TopicId" format="<meta name=""Microsoft.Help.Id"" content=""%%TopicId%%""/>" --><meta name="Microsoft.Help.Id" content="IVM Database_db~s-dbo~p-proc_IVM_UnloadTruckToTemp_1859"/><!--DXMETADATA end-->
    <!--DXMETADATA start type="Synopsis" StripHtmlTags="True" MaxLength="250" format="<meta name=""Description"" content=""%%Synopsis%%"" />"--><meta name="Description" content="Unload from Truck into storage." /><!--DXMETADATA end-->
    <!--DXMETADATA start type="TocParentId" format="<meta name=""Microsoft.Help.TocParent"" content=""%%TocParentId%%""/>" --><!--DXMETADATA end-->
    <meta name="Microsoft.Help.ContentType" content="Reference" />
    <!--DXMETADATA start type="MshvKeywords" condition="helpversion:value=3" --><!--DXMETADATA end-->
    <!--DXMETADATA start type="MshvMetaTags" condition="helpversion:value=3" --><!--DXMETADATA end-->
    <!--DXMETADATA start type="Help3CatalogLocale" condition="helpversion:value=3" format="<meta name=""Microsoft.Help.Locale"" content=""%%Help3CatalogLocale%%"" />"--><!--DXMETADATA end-->
    <!--DXMETADATA start type="Help3CatalogLocale" condition="helpversion:value=3" format="<meta name=""Microsoft.Help.TopicLocale"" content=""%%Help3CatalogLocale%%"" />"--><!--DXMETADATA end-->
    
    <!--DXMETADATA start type="Stylesheets" --><link rel="stylesheet" type="text/css" href="stylesheets/Title.css"></link>
    <link rel="stylesheet" type="text/css" href="stylesheets/customstyles.css"></link><!--DXMETADATA end-->
    <!--DXMETADATA start type="Scripts" --><!--DXMETADATA end-->

    <!--DXMETADATA start type="DesignTime"--><!--DXMETADATA end-->

    <!--DXMETADATA start type="Scrap" condition="communityenabled" name="_COMMUNITY_PROPERTIES" --><!--DXMETADATA end -->

    <!--DXMETADATA start type="CustomHeadContent" --><!--DXMETADATA end-->
</head>

<body>
    <div id="i-before-header-content" class="i-before-header-content">
        
    </div>
    <div id="i-header-content" class="i-header-content">
        <!--DXMETADATA start type="LogoImage" --><!--DXMETADATA end-->
            <div class="i-project-title"><!--DXMETADATA start type="ProjectTitle" -->Inventory Management (FC.IVM)<!--DXMETADATA end--></div>
        <div class="i-page-title"><div class="i-page-title-text"><!--DXMETADATA start type="LocalItemTitle" -->dbo.proc_IVM_UnloadTruckToTemp_1859 Stored Procedure<!--DXMETADATA end--></div></div>
    </div>
    <div id="i-after-header-content" class="i-after-header-content">
        <!-- Spacing --> <span class="i-toggle-all-sections i-function-link">
                <label class="i-collapse-all"><!--DXMETADATA start type="Phrase" name="COLLAPSE_ALL" -->Collapse All<!--DXMETADATA end--></label>
                <label class="i-expand-all" style="display: none;"><!--DXMETADATA start type="Phrase" name="EXPAND_ALL" -->Expand All<!--DXMETADATA end--></label>
            </span><!--DXMETADATA start type="Literal" condition="communityenabled" value="%%scrap:name=_COMMUNITY_DROPDOWN%%" --><!--DXMETADATA end -->
        <!--DXMETADATA start type="IsWebOutputRootPageLinkEnabled" format="<a href='#' class="i-page-link" class="i-view-in-frame-link" title='$$VIEW_WITH_NAVIGATION_TOOLS_TIP$$' style='display: none' data-root-page='%%WebOutputRootPage%%%%OutputFileExtension%%' target='_top'>$$VIEW_WITH_NAVIGATION_TOOLS_TEXT$$</a>" --><!--DXMETADATA end-->
    </div>
    <!--DXMETADATA start type="Breadcrumbs" scrap="_BREADCRUMBS" --><div class="i-breadcrumbs-container"><table><tr><td>
<a href="IVM Database_db.html">IVM Database Database</a>
 > <a href="IVM Database_db~s-dbo.html">dbo Schema</a>
 : dbo.proc_IVM_UnloadTruckToTemp_1859 Stored Procedure</td></tr></table></div><!--DXMETADATA end -->
    
    
    <div id="i-body-content" class="i-body-content">
        <!--DXMETADATA start type="Description" source="Item" format="%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=description,caption=$$Description$$%%<div class=""i-description-content"">%%description%%</div></div>" --><div class="i-section-heading" id="i-description-section-heading"><span class="i-section-heading-icon"><!-- --></span><span class="i-section-heading-text">Description</span></div><div id="i-description-section-content" class="i-section-content"><div class="i-description-content"><P>Unload from Truck into storage.</P>
<P>To unload amount from truck into storage buffer table which another user will confirm on next day. </P></div></div><!--DXMETADATA end -->
            <!--DXMETADATA start type="FilteredItemList" scrap="PROPERTY_LIST" namespace="property" source="Item" filter="" format="%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=properties,caption=$$properties$$%%%%filtereditemlist%%</div>" --><div class="i-section-heading" id="i-properties-section-heading"><span class="i-section-heading-icon"><!-- --></span><span class="i-section-heading-text">Properties</span></div><div id="i-properties-section-content" class="i-section-content"><table class="i-property-list">
<tr><td>Creation Date</td><td>19/02/2018 13:52:44</td></tr>
<tr><td>Encrypted</td><td><img src="template/packages/core-db/images/boolean-false.gif"/></td></tr>
<tr><td>Ansi Nulls</td><td><img src="template/packages/core-db/images/boolean-true.gif"/></td></tr>
</table></div><!--DXMETADATA end -->
            <!--DXMETADATA start type="FilteredItemList" scrap="PARAMETER_LIST" namespace="parameter" source="Item" filter="" format="%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=parameters,caption=$$parameters$$%%%%filtereditemlist%%</div>" --><div class="i-section-heading" id="i-parameters-section-heading"><span class="i-section-heading-icon"><!-- --></span><span class="i-section-heading-text">Parameters</span></div><div id="i-parameters-section-content" class="i-section-content"><table class="i-column-list"><tr><th>Parameter</th><th NOWRAP>Direction</th><th NOWRAP>Description</th><th NOWRAP>Data Type</th><th NOWRAP>Size</th></tr>
<tr><td class="i-link">@TicketTruck</td><td>In</td><td class="i-description">ตั๋วชั่ง</td><td>143</td><td>0</td></tr>
<tr><td class="i-link">@DestStorage</td><td>In</td><td class="i-description">พื้นที่ปลายทาง</td><td>143</td><td>0</td></tr>
<tr><td class="i-link">@UserID</td><td>In</td><td class="i-description">ผู้ทำรายการ</td><td>Integer</td><td>4</td></tr>
<tr><td class="i-link">@RETURN_VALUE</td><td>Return Value</td><td class="i-description">&nbsp;</td><td>Integer</td><td>4</td></tr>
</table></div><!--DXMETADATA end -->
            <!--DXMETADATA start type="TaggedComment" source="Item" id="##RETURNS" format="%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=returns,caption=$$Return_Type$$%%<p>%%comment%%</p></div>" --><!--DXMETADATA end -->
            <!--DXMETADATA start type="TaggedComment" source="Item" id="##REMARKS" format="%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=remarks,caption=$$Remarks$$%%<p>%%comment%%</p></div>" --><div class="i-section-heading" id="i-remarks-section-heading"><span class="i-section-heading-icon"><!-- --></span><span class="i-section-heading-text">Remarks</span></div><div id="i-remarks-section-content" class="i-section-content"><p>ข้อมูลการทำรายการ Unload วัตถุดิบ ที่ยังไม่ได้ทำการคอนเฟิร์ม</p></div><!--DXMETADATA end -->
            <!--DXMETADATA start type="FilteredItemList" scrap="PROCEDURE_PERMISSIONS" namespace="user" source="Item" filter="type=permissions" format="%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=userpermissions,caption=$$user$$ $$permissions$$%%%%filtereditemlist%%</div>" --><!--DXMETADATA end -->
            <!--DXMETADATA start type="FilteredItemList" scrap="PROCEDURE_PERMISSIONS" namespace="role" source="Item" filter="type=permissions" format="%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=rolepermissions,caption=$$role$$ $$permissions$$%%%%filtereditemlist%%</div>" --><!--DXMETADATA end -->
            <!--DXMETADATA start type="FilteredItemList" scrap="DEPENDENCY_LIST" namespace="child item" source="Item" filter="type=children" format="%%replaceinquotes:value=false%%%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=children,caption=""$$dependent_child$$""%%%%filtereditemlist%%</div>" --><!--DXMETADATA end -->
            <!--DXMETADATA start type="FilteredItemList" scrap="DEPENDENCY_LIST" namespace="child item" source="Item" filter="type=parent" format="%%replaceinquotes:value=false%%%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=parents,caption=""$$dependent_parent$$""%%%%filtereditemlist%%</div>" --><!--DXMETADATA end -->
            <!--DXMETADATA start type="Source" format="%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=source,caption=$$ProcedureSource$$%%<table class="i-sql-source" border=0 cellpadding=0><tr><td><CODE>%%Source%%</CODE></td></tr></table></div>" --><div class="i-section-heading" id="i-source-section-heading"><span class="i-section-heading-icon"><!-- --></span><span class="i-section-heading-text">Procedure Source Code</span></div><div id="i-source-section-content" class="i-section-content"><table class="i-sql-source" border=0 cellpadding=0><tr><td><CODE><pre><span style="color: #008080; ">-- =============================================
-- Author:        Yuthapong Wongtharua
-- Create date: 31 Jan 2018
-- Description:    Unload from Truck into storage
-- =============================================
/*
    Objective: to unload amount from truck into storage buffer table which another user will confirm on next day.
    19/2/2018: change to use user define table to be interface table. This will update Truck information and unload into storage area also.
    12/3/2018: Add to DT_StorageAreaMaterialBuffer
    23 Apr 2018: Change weight to DT_StorageAreaBuffer to kg unit
    25 Jun 2018:Add Stock Date column in DT_StorageAreaMaterialBuffer
*/</span>
<span style="color: #0000FF; ">CREATE</span> <span style="color: #0000FF; ">PROCEDURE</span> proc_IVM_UnloadTruckToTemp_1859
    
    <span style="color: #008000; ">@TicketTruck</span> TblTicket ReadOnly,
    <span style="color: #008000; ">@DestStorage</span> TblUnloadFromTruck Readonly,
    <span style="color: #008000; ">@UserID</span> <span style="color: #0000FF; ">Int</span>
<span style="color: #0000FF; ">AS</span>

<span style="color: #0000FF; ">BEGIN</span>
    <span style="color: #0000FF; ">SET</span> NOCOUNT <span style="color: #0000FF; ">ON</span>;
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@TotalAmount</span> <span style="color: #0000FF; ">float</span><span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">0</span>;
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@TotalADT</span> <span style="color: #0000FF; ">float</span><span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">0</span>;
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@TotalMillWeight</span> <span style="color: #0000FF; ">float</span><span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">0</span>;
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@UnitWeight</span> <span style="color: #0000FF; ">float</span><span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">0</span>;

    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@QuantityTypeID_MillWeight</span> <span style="color: #0000FF; ">Int</span><span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">2</span>;
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@QuantityTypeID_Bale</span> <span style="color: #0000FF; ">Int</span><span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">4</span>;
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@QuantityTypeID_ADT</span> <span style="color: #0000FF; ">Int</span><span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">3</span>;
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@StdMP</span> <span style="color: #0000FF; ">Int</span>; <span style="color: #008080; ">-- use when ADT is not found
</span>
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@StatusID_Create</span> <span style="color: #0000FF; ">Int</span><span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">1</span>;
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@PackageSizeID</span> <span style="color: #0000FF; ">Int</span>;
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@MaterialID</span> <span style="color: #0000FF; ">int</span>;
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@SupplierID</span> <span style="color: #0000FF; ">Int</span>

    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@Ticket</span> <span style="color: #0000FF; ">varchar</span>(<span style="color: #800000; font-weight: bold; ">20</span>)
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@Ticket_Amount</span> <span style="color: #0000FF; ">float</span>;
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@ContractorName</span> <span style="color: #0000FF; ">varchar</span>(<span style="color: #800000; font-weight: bold; ">50</span>);
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@MaterialCategory</span> <span style="color: #0000FF; ">varchar</span>(<span style="color: #800000; font-weight: bold; ">50</span>);
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@SealBaling</span> <span style="color: #0000FF; ">varchar</span>(<span style="color: #800000; font-weight: bold; ">50</span>);
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@TransferPoint</span> <span style="color: #0000FF; ">varchar</span>(<span style="color: #800000; font-weight: bold; ">50</span>);
    
    
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@Asg_TotalAmount</span> <span style="color: #0000FF; ">float</span>;

    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@tmpID</span> <span style="color: #0000FF; ">Int</span>;


    <span style="color: #0000FF; ">Select</span> <span style="color: #008000; ">@ticket</span><span style="color: #808080; ">=</span>d.Ticket,<span style="color: #008000; ">@Ticket_Amount</span><span style="color: #808080; ">=</span>d.BaleAmount,<span style="color: #008000; ">@ContractorName</span><span style="color: #808080; ">=</span>d.ContractorName
    ,<span style="color: #008000; ">@MaterialCategory</span><span style="color: #808080; ">=</span>d.MaterialCategory,<span style="color: #008000; ">@SealBaling</span> <span style="color: #808080; ">=</span>d.BalingSealValidity,<span style="color: #008000; ">@TransferPoint</span><span style="color: #808080; ">=</span>d.TransferPoint
    <span style="color: #0000FF; ">From</span> <span style="color: #008000; ">@TicketTruck</span> d;

    <span style="color: #0000FF; ">Select</span> <span style="color: #008000; ">@Asg_TotalAmount</span><span style="color: #808080; ">=</span><span style="color: #FF00FF; ">isnull</span>(<span style="color: #FF00FF; ">sum</span>(d.Amount),<span style="color: #800000; font-weight: bold; ">0</span>)
    <span style="color: #0000FF; ">From</span> <span style="color: #008000; ">@DestStorage</span> d


ValidationProcess:
    <span style="color: #0000FF; ">If</span> <span style="color: #808080; ">exists</span>(<span style="color: #0000FF; ">select</span> <span style="color: #800000; font-weight: bold; ">1</span> <span style="color: #0000FF; ">from</span> DT_InboundStorageBuffer d <span style="color: #0000FF; ">where</span> d.Ticket<span style="color: #808080; ">=</span><span style="color: #008000; ">@Ticket</span>)
        <span style="color: #0000FF; ">begin</span>
            <span style="color: #0000FF; ">RaisError</span>(<span style="color: #FF0000; ">'This ticket already was assigned'</span>,<span style="color: #800000; font-weight: bold; ">11</span>,<span style="color: #800000; font-weight: bold; ">11</span>)
            <span style="color: #0000FF; ">Return</span>
        <span style="color: #0000FF; ">end</span>
    <span style="color: #0000FF; ">Set</span> <span style="color: #008000; ">@MaterialID</span> <span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">0</span>;
    <span style="color: #0000FF; ">Set</span> <span style="color: #008000; ">@SupplierID</span> <span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">0</span>;
    <span style="color: #0000FF; ">Select</span> <span style="color: #008000; ">@MaterialID</span> <span style="color: #808080; ">=</span>DI.MaterialID,<span style="color: #008000; ">@SupplierID</span> <span style="color: #808080; ">=</span> DISup.SupplierID 
    <span style="color: #0000FF; ">From</span> DT_Inbound DI
    <span style="color: #808080; ">Join</span> View_DTInbound_LatestVersionID V <span style="color: #0000FF; ">on</span> V.ID<span style="color: #808080; ">=</span>DI.ID 
    <span style="color: #808080; ">Left</span> <span style="color: #808080; ">Join</span> DT_InboundSupplier DISup <span style="color: #0000FF; ">on</span> DISup.DT_InboundID <span style="color: #808080; ">=</span>DI.ID <span style="color: #808080; ">and</span> DISup.SupplierTypeID <span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">2</span>
    <span style="color: #0000FF; ">where</span> di.DocID<span style="color: #808080; ">=</span><span style="color: #008000; ">@Ticket</span>;

    <span style="color: #0000FF; ">If</span> <span style="color: #008000; ">@MaterialID</span> <span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">0</span> <span style="color: #808080; ">or</span> <span style="color: #008000; ">@SupplierID</span> <span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">0</span> 
        <span style="color: #0000FF; ">begin</span>
            <span style="color: #0000FF; ">RaisError</span>(<span style="color: #FF0000; ">'Material / Supplier not found'</span>,<span style="color: #800000; font-weight: bold; ">11</span>,<span style="color: #800000; font-weight: bold; ">11</span>)
            <span style="color: #0000FF; ">return</span> 
        <span style="color: #0000FF; ">end</span>
    <span style="color: #008080; ">-- save quantity into ticket before compare.. user may change in tablet
</span>    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@InputQty</span> <span style="color: #0000FF; ">float</span><span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">0</span>
    <span style="color: #0000FF; ">select</span>  <span style="color: #008000; ">@InputQty</span> <span style="color: #808080; ">=</span> t.BaleAmount 
    <span style="color: #0000FF; ">From</span> <span style="color: #008000; ">@TicketTruck</span> t;
    <span style="color: #0000FF; ">If</span> <span style="color: #008000; ">@InputQty</span> <span style="color: #808080; ">&gt;</span><span style="color: #800000; font-weight: bold; ">0</span> 
        <span style="color: #0000FF; ">begin</span>
            <span style="color: #0000FF; ">Update</span> d1
            <span style="color: #0000FF; ">set</span> d1.Amount <span style="color: #808080; ">=</span><span style="color: #008000; ">@InputQty</span> 
            <span style="color: #0000FF; ">from</span> DT_Inbound di
            <span style="color: #808080; ">join</span> View_DTInbound_LatestVersionID v <span style="color: #0000FF; ">on</span> v.ID <span style="color: #808080; ">=</span> DI.id 
            <span style="color: #808080; ">Join</span> DT_InboundQuantity d1 <span style="color: #0000FF; ">on</span> d1.DT_InboundID <span style="color: #808080; ">=</span>DI.id
            <span style="color: #0000FF; ">where</span> di.DocID <span style="color: #808080; ">=</span><span style="color: #008000; ">@Ticket</span>;
        <span style="color: #0000FF; ">end</span>

    <span style="color: #0000FF; ">Select</span> <span style="color: #008000; ">@TotalAmount</span><span style="color: #808080; ">=</span><span style="color: #FF00FF; ">Isnull</span>(DQTY.Amount,<span style="color: #800000; font-weight: bold; ">0</span>),<span style="color: #008000; ">@TotalADT</span><span style="color: #808080; ">=</span><span style="color: #FF00FF; ">Isnull</span>(DADT.Amount,<span style="color: #800000; font-weight: bold; ">0</span>),<span style="color: #008000; ">@UnitWeight</span><span style="color: #808080; ">=</span><span style="color: #FF00FF; ">Isnull</span>(DADT.Amount,<span style="color: #800000; font-weight: bold; ">0</span>)<span style="color: #808080; ">/</span><span style="color: #FF00FF; ">NullIF</span>(DQTY.Amount,<span style="color: #800000; font-weight: bold; ">0</span>)
    ,<span style="color: #008000; ">@TotalMillWeight</span> <span style="color: #808080; ">=</span> <span style="color: #FF00FF; ">ISNULL</span>(DMW.Amount ,<span style="color: #800000; font-weight: bold; ">0</span>)
    <span style="color: #0000FF; ">From</span> DT_Inbound DI
    <span style="color: #808080; ">Join</span> View_DTInbound_LatestVersionID V <span style="color: #0000FF; ">on</span> V.ID<span style="color: #808080; ">=</span>DI.ID 
    <span style="color: #808080; ">Left</span> <span style="color: #808080; ">Join</span> DT_InboundQuantity DQty <span style="color: #0000FF; ">on</span> DQty.DT_InboundID<span style="color: #808080; ">=</span>DI.ID <span style="color: #808080; ">and</span> DQty.QuantityTypeID<span style="color: #808080; ">=</span><span style="color: #008000; ">@QuantityTypeID_Bale</span>
    <span style="color: #808080; ">Left</span> <span style="color: #808080; ">Join</span> DT_InboundQuantity DADT <span style="color: #0000FF; ">on</span> DADT.DT_InboundID<span style="color: #808080; ">=</span>DI.ID <span style="color: #808080; ">and</span> DADT.QuantityTypeID<span style="color: #808080; ">=</span><span style="color: #008000; ">@QuantityTypeID_ADT</span>
    <span style="color: #808080; ">Left</span> <span style="color: #808080; ">Join</span> DT_InboundQuantity DMW <span style="color: #0000FF; ">on</span> DMW.DT_InboundID<span style="color: #808080; ">=</span>DI.ID <span style="color: #808080; ">and</span> DMW.QuantityTypeID<span style="color: #808080; ">=</span><span style="color: #008000; ">@QuantityTypeID_MillWeight</span> 
    <span style="color: #0000FF; ">where</span> di.DocID<span style="color: #808080; ">=</span><span style="color: #008000; ">@Ticket</span>;

    <span style="color: #0000FF; ">If</span> <span style="color: #008000; ">@TotalAmount</span> <span style="color: #0000FF; ">is</span> <span style="color: #0000FF; ">null</span> <span style="color: #808080; ">or</span> <span style="color: #008000; ">@TotalAmount</span><span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">0</span>
        <span style="color: #0000FF; ">begin</span>
            <span style="color: #0000FF; ">RaisError</span>(<span style="color: #FF0000; ">'Amount of this truck is not found. Please check'</span>,<span style="color: #800000; font-weight: bold; ">11</span>,<span style="color: #800000; font-weight: bold; ">11</span>)
            <span style="color: #0000FF; ">Return</span>
        <span style="color: #0000FF; ">end</span>

    <span style="color: #0000FF; ">If</span> <span style="color: #008000; ">@Asg_TotalAmount</span> <span style="color: #808080; ">&lt;&gt;</span> <span style="color: #008000; ">@TotalAmount</span>
        <span style="color: #0000FF; ">begin</span>
            <span style="color: #0000FF; ">RaisError</span>(<span style="color: #FF0000; ">'Error on amount because your input is not equal amount on truck.'</span>,<span style="color: #800000; font-weight: bold; ">11</span>,<span style="color: #800000; font-weight: bold; ">11</span>)
            <span style="color: #0000FF; ">Return</span>
        <span style="color: #0000FF; ">end</span>
        
    <span style="color: #0000FF; ">If</span> <span style="color: #008000; ">@TotalADT</span> <span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">0</span> 
        <span style="color: #0000FF; ">begin</span>
            <span style="color: #008080; ">-- find standar mp from price
</span>            <span style="color: #0000FF; ">Set</span> <span style="color: #008000; ">@StdMP</span> <span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">12</span>; <span style="color: #008080; ">-- default
</span>            <span style="color: #0000FF; ">Select</span> <span style="color: #0000FF; ">top</span> <span style="color: #800000; font-weight: bold; ">1</span> <span style="color: #008000; ">@StdMP</span> <span style="color: #808080; ">=</span> m1.StandardValue 
            <span style="color: #0000FF; ">From</span> MT_SupplierMaterial m1
            <span style="color: #0000FF; ">where</span> m1.MaterialID <span style="color: #808080; ">=</span> <span style="color: #008000; ">@MaterialID</span> <span style="color: #808080; ">and</span> m1.SupplierID <span style="color: #808080; ">=</span><span style="color: #008000; ">@SupplierID</span> 
            <span style="color: #808080; ">and</span> m1.EffectiveDate <span style="color: #808080; ">&lt;=</span> <span style="color: #FF00FF; ">GETDATE</span>() <span style="color: #808080; ">and</span> m1.LastUseDate <span style="color: #808080; ">&gt;=</span> <span style="color: #FF00FF; ">GETDATE</span>()
            <span style="color: #808080; ">and</span> m1.QCID<span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">1</span>

            <span style="color: #0000FF; ">Set</span> <span style="color: #008000; ">@TotalADT</span> <span style="color: #808080; ">=</span> <span style="color: #008000; ">@TotalMillWeight</span> <span style="color: #808080; ">*</span>(<span style="color: #800000; font-weight: bold; ">100</span><span style="color: #808080; ">-</span><span style="color: #008000; ">@StdMP</span> )<span style="color: #808080; ">/</span><span style="color: #800000; font-weight: bold; ">90</span>
            <span style="color: #0000FF; ">Set</span> <span style="color: #008000; ">@UnitWeight</span> <span style="color: #808080; ">=</span> <span style="color: #008000; ">@TotalADT</span> <span style="color: #808080; ">/</span><span style="color: #008000; ">@TotalAmount</span> 
        <span style="color: #0000FF; ">end</span>


    <span style="color: #008080; ">/*
        Problem to calculate weight here is it must be related weight with other package in same truck which cannot know now.
        Moreover, truck may still not weight out yet which weight in ticket still not final yet.
        Moreover, moisture may be confirmed later which made ADT Weight here is changed.
    */</span>
UpdateTruckInfo:
    <span style="color: #0000FF; ">Begin</span> <span style="color: #0000FF; ">Transaction</span>;
        <span style="color: #008080; ">-- Material
</span>        <span style="color: #0000FF; ">Update</span> di
        <span style="color: #0000FF; ">Set</span> di.MaterialID<span style="color: #808080; ">=</span><span style="color: #008000; ">@MaterialID</span>
        <span style="color: #0000FF; ">From</span> DT_Inbound di
        <span style="color: #808080; ">Join</span> View_DTInbound_LatestVersionID V <span style="color: #0000FF; ">on</span> V.ID <span style="color: #808080; ">=</span> DI.ID
        <span style="color: #0000FF; ">where</span> di.DocID<span style="color: #808080; ">=</span><span style="color: #008000; ">@Ticket</span>;
        <span style="color: #008080; ">-- Bale Amount
</span>        <span style="color: #0000FF; ">Update</span> d
        <span style="color: #0000FF; ">Set</span> d.Amount<span style="color: #808080; ">=</span><span style="color: #008000; ">@Ticket_Amount</span>
        <span style="color: #0000FF; ">From</span> DT_InboundQuantity d
        <span style="color: #808080; ">Join</span> DT_Inbound DI <span style="color: #0000FF; ">on</span> DI.ID<span style="color: #808080; ">=</span> D.DT_InboundID
        <span style="color: #808080; ">Join</span> View_DTInbound_LatestVersionID V <span style="color: #0000FF; ">on</span> V.id <span style="color: #808080; ">=</span> di.id 
        <span style="color: #0000FF; ">where</span> di.DocID<span style="color: #808080; ">=</span><span style="color: #008000; ">@Ticket</span>
        <span style="color: #808080; ">and</span> d.QuantityTypeID<span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">4</span>;
    <span style="color: #0000FF; ">Commit</span>;

    <span style="color: #008080; ">-- Document
</span>    <span style="color: #0000FF; ">exec</span> proc_UpdateMPlanRefDocument <span style="color: #008000; ">@ticket</span>,<span style="color: #800000; font-weight: bold; ">159</span>,<span style="color: #008000; ">@ContractorName</span>,<span style="color: #008000; ">@UserID</span>; <span style="color: #008080; ">--Contractor
</span>    <span style="color: #0000FF; ">exec</span> proc_UpdateMPlanRefDocument <span style="color: #008000; ">@ticket</span>,<span style="color: #800000; font-weight: bold; ">318</span>,<span style="color: #008000; ">@MaterialCategory</span>,<span style="color: #008000; ">@UserID</span>; <span style="color: #008080; ">-- Material Category
</span>    <span style="color: #0000FF; ">exec</span> proc_UpdateMPlanRefDocument <span style="color: #008000; ">@ticket</span>,<span style="color: #800000; font-weight: bold; ">319</span>,<span style="color: #008000; ">@SealBaling</span>,<span style="color: #008000; ">@UserID</span>; <span style="color: #008080; ">-- SealBaling
</span>    <span style="color: #0000FF; ">exec</span> proc_UpdateMPlanRefDocument <span style="color: #008000; ">@ticket</span>,<span style="color: #800000; font-weight: bold; ">320</span>,<span style="color: #008000; ">@TransferPoint</span>,<span style="color: #008000; ">@UserID</span>; <span style="color: #008080; ">-- Transferpoint
</span>

UpdateDestStorageBuffer:    
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@tblSt</span> <span style="color: #0000FF; ">table</span> (ID <span style="color: #0000FF; ">Int</span> <span style="color: #FF00FF; ">identity</span>,DestStorageID <span style="color: #0000FF; ">Int</span>,Amount <span style="color: #0000FF; ">Int</span>,PackageName <span style="color: #0000FF; ">varchar</span>(<span style="color: #800000; font-weight: bold; ">20</span>));
    <span style="color: #0000FF; ">Insert</span> <span style="color: #0000FF; ">into</span> <span style="color: #008000; ">@tblst</span> (DestStorageID,Amount,PackageName)
    <span style="color: #0000FF; ">Select</span> d.DestinationStorageID,d.Amount,d.PackageName
    <span style="color: #0000FF; ">From</span> <span style="color: #008000; ">@DestStorage</span> d ;

    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@WorkID</span> <span style="color: #0000FF; ">Int</span><span style="color: #808080; ">=</span><span style="color: #800000; font-weight: bold; ">1</span>
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@TotalRec</span> <span style="color: #0000FF; ">Int</span>
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@BufferID</span> <span style="color: #0000FF; ">Int</span>
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@StockBufferID</span> <span style="color: #0000FF; ">Int</span>
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@WorkStorageID</span> <span style="color: #0000FF; ">Int</span>;
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@WorkAmount</span> <span style="color: #0000FF; ">float</span>;
    <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@WorkPkgName</span> <span style="color: #0000FF; ">varchar</span>(<span style="color: #800000; font-weight: bold; ">20</span>);

    <span style="color: #0000FF; ">Select</span> <span style="color: #008000; ">@TotalRec</span><span style="color: #808080; ">=</span><span style="color: #FF00FF; ">Count</span>(t.id)
    <span style="color: #0000FF; ">From</span> <span style="color: #008000; ">@tblSt</span> t;

    <span style="color: #0000FF; ">Begin</span> Try
        <span style="color: #0000FF; ">Begin</span> <span style="color: #0000FF; ">Transaction</span>;
        <span style="color: #0000FF; ">While</span> <span style="color: #008000; ">@WorkID</span> <span style="color: #808080; ">&lt;=</span> <span style="color: #008000; ">@TotalRec</span>
            <span style="color: #0000FF; ">Begin</span>
                <span style="color: #0000FF; ">Select</span> <span style="color: #008000; ">@WorkStorageID</span><span style="color: #808080; ">=</span>t.DestStorageID,<span style="color: #008000; ">@WorkAmount</span><span style="color: #808080; ">=</span>t.Amount,<span style="color: #008000; ">@WorkPkgName</span><span style="color: #808080; ">=</span>t.PackageName
                <span style="color: #0000FF; ">From</span> <span style="color: #008000; ">@tblSt</span> t
                <span style="color: #0000FF; ">where</span> t.id<span style="color: #808080; ">=</span><span style="color: #008000; ">@WorkID</span>;

                <span style="color: #0000FF; ">exec</span> X10_SP_GetNextID <span style="color: #FF0000; ">'DT_InboundStorageBuffer'</span>,<span style="color: #008000; ">@UserID</span>,<span style="color: #008000; ">@BufferID</span> Output;
                <span style="color: #0000FF; ">Insert</span> <span style="color: #0000FF; ">into</span> DT_InboundStorageBuffer (ID,Ticket,DestinationStorageID,Amount,<span style="color: #FF0000; ">[EstWeight]</span>,StatusID,PackageSizeName,InsertDate,UpdateDate,InsertUserID,UpdateUserID)
                <span style="color: #0000FF; ">Values</span>(<span style="color: #008000; ">@BufferID</span>,<span style="color: #008000; ">@Ticket</span>,<span style="color: #008000; ">@WorkStorageID</span>,<span style="color: #008000; ">@WorkAmount</span>,<span style="color: #FF00FF; ">Round</span>(<span style="color: #008000; ">@UnitWeight</span><span style="color: #808080; ">*</span><span style="color: #008000; ">@WorkAmount</span>,<span style="color: #800000; font-weight: bold; ">3</span>),<span style="color: #008000; ">@StatusID_Create</span>,<span style="color: #008000; ">@WorkPkgName</span>,<span style="color: #FF00FF; ">Getdate</span>(),<span style="color: #FF00FF; ">Getdate</span>(),<span style="color: #008000; ">@UserID</span>,<span style="color: #008000; ">@UserID</span>);

                <span style="color: #008080; ">/*
                We need to put into DT_StorageAreaMaterialBuffer because there is a case user may want to move things from stock which is relate to buffer amount
                */</span>
                <span style="color: #0000FF; ">exec</span> X10_SP_GetNextID <span style="color: #FF0000; ">'DT_StorageAreaMaterialBuffer'</span>,<span style="color: #008000; ">@UserID</span>,<span style="color: #008000; ">@StockBufferID</span> Output;
                <span style="color: #0000FF; ">Insert</span> <span style="color: #0000FF; ">into</span> DT_StorageAreaMaterialBuffer(ID,SourceStorageID,DestinationStorageID,MaterialID,Amount,Weight,StatusID
                ,StockDate,InsertDate,UpdateDate,InsertUserID ,UpdateUserID)
                <span style="color: #0000FF; ">Values</span>(<span style="color: #008000; ">@StockBufferID</span>,<span style="color: #0000FF; ">Null</span>,<span style="color: #008000; ">@WorkStorageID</span>,<span style="color: #008000; ">@MaterialID</span>,<span style="color: #008000; ">@WorkAmount</span>,<span style="color: #FF00FF; ">Round</span>(<span style="color: #008000; ">@UnitWeight</span><span style="color: #808080; ">*</span><span style="color: #008000; ">@WorkAmount</span><span style="color: #808080; ">*</span><span style="color: #800000; font-weight: bold; ">1000</span>,<span style="color: #800000; font-weight: bold; ">3</span>),<span style="color: #008000; ">@StatusID_Create</span>
                ,<span style="color: #FF00FF; ">GetDate</span>(),<span style="color: #FF00FF; ">Getdate</span>(),<span style="color: #FF00FF; ">Getdate</span>(),<span style="color: #008000; ">@UserID</span>,<span style="color: #008000; ">@UserID</span>);


                <span style="color: #0000FF; ">Set</span> <span style="color: #008000; ">@WorkID</span><span style="color: #808080; ">+=</span><span style="color: #800000; font-weight: bold; ">1</span>;
            <span style="color: #0000FF; ">End</span>
        <span style="color: #0000FF; ">Commit</span>;
    <span style="color: #0000FF; ">End</span> Try
    <span style="color: #0000FF; ">Begin</span> Catch
        <span style="color: #0000FF; ">RollBack</span>;
        <span style="color: #0000FF; ">Declare</span> <span style="color: #008000; ">@Usermsg</span> <span style="color: #0000FF; ">varchar</span>(<span style="color: #800000; font-weight: bold; ">2000</span>)
        <span style="color: #0000FF; ">Set</span> <span style="color: #008000; ">@UserMSG</span><span style="color: #808080; ">=</span>ERROR_MESSAGE()
        <span style="color: #0000FF; ">RaisError</span>(<span style="color: #008000; ">@UserMsg</span>,<span style="color: #800000; font-weight: bold; ">11</span>,<span style="color: #800000; font-weight: bold; ">11</span>)
        <span style="color: #0000FF; ">Return</span>
    <span style="color: #0000FF; ">End</span> Catch



    <span style="color: #0000FF; ">PRINT</span> <span style="color: #FF0000; ">'Success'</span>

<span style="color: #0000FF; ">END</span>
</pre></CODE></td></tr></table></div><!--DXMETADATA end -->
            <a name="seealsobookmark"></a>
            <!--DXMETADATA start type="FilteredItemList" scrap="CATEGORIZED_LINKS" namespace="linkcategory" source="Item" filter="" NoHeader="True" NoFooter="True" format="%%replaceinquotes:value=false%%%%scrap:name=_COLLAPSIBLE_HEADER,idprefix=seealso,caption=""$$See_Also$$%%designlist:tagidentifier=##SEEALSO,itemtype=See Also%%""%%%%filtereditemlist%%</div>"--><div class="i-section-heading" id="i-seealso-section-heading"><span class="i-section-heading-icon"><!-- --></span><span class="i-section-heading-text">See Also</span></div><div id="i-seealso-section-content" class="i-section-content"><h4 class=dxh4>Related Objects</h4><p><a href="IVM Database_db~s-dbo.html">dbo Schema</a>
<BR/><a href="IVM Database_db.html">IVM Database Database</a>
</p>
</div><!--DXMETADATA end-->
        
    </div>
    <div id="i-footer-content" class="i-footer-content">
        <!--DXMETADATA start type="Scrap" condition="communityenabled" name="_COMMUNITY_FOOTER" --><!--DXMETADATA end -->
<!--DXMETADATA start type="Variable" name="CopyrightNotice" format="<p>&nbsp;</p><p>&nbsp;</p><hr style=""height: 1px"" /><p>%%variable%%</p>" --><p>&nbsp;</p><p>&nbsp;</p><hr style="height: 1px" /><p>&copy; 2018 All Rights Reserved.</p><!--DXMETADATA end -->
<!--DXMETADATA start type="Variable" name="FeedbackLink" format="" --><a href="mailto:support@company.com?subject=Documentation Feedback: IVM Database_db~s-dbo~p-proc_IVM_UnloadTruckToTemp_1859.html">Send comments</a> on this topic.<!--DXMETADATA end-->
    </div>
    

    <!--DXMETADATA start type="IsNew" format="<script type=""text/javascript"">setIsNew = true;</script>" --><!--DXMETADATA end-->
    <!--DXMETADATA start type="IsTemplateFileFeatureEnabled" name="Responsive" format="<script type=""text/javascript"">setIsResponsiveEnabled = true;</script>" --><!--DXMETADATA end-->
    <script type="text/javascript">
        $(function() {
            var documentInstance = new Innovasys.Content.Document(document.body);
            documentInstance.isNew = !(typeof setIsNew === "undefined");
            documentInstance.isResponsiveEnabled = !(typeof setIsResponsiveEnabled === "undefined");
            documentInstance.load();
        });
    </script>
</body>
</html>
